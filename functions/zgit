# Git wrapper for bulk operations on repositories defined in $GHDIR
# Usage: zgit <command>
# Commands: pull, push, push-force, list, reset, status, help

# Ensure configuration is present
if [[ -z "$GHDIR" ]]; then
    printe "Error: \$GHDIR is not set."
    return 1
fi

local cmd="help"

# Safe argument parsing to avoid shift error if no args provided
if (( ARGC > 0 )); then
    cmd="$1"
    shift # Remove command from arguments to pass remaining args if needed
fi

# Define repository list glob pattern (cached literal, evaluated only when needed)
# (/) qualifier selects only directories
local repo_glob="$GHDIR/*(/)"

case "$cmd" in
    pull)
        local -a repos=($~repo_glob)
        local count=${#repos}
        (( count == 0 )) && { printe "No repositories found in $GHDIR."; return 1; }

        printc "Pulling $count repositories from the remote." $y
        ptint "Working directory: $c$GHDIR$c"

        local i=1 repo
        for repo in $repos; do
            printc "\n$i/$count ${repo:t}" $g
            printc "$(git -C "$repo" remote get-url origin)" $c

            # Capture stderr to filter known benign errors
            git -C "$repo" pull --rebase 2>&1 | while read line; do
                if [[ "$line" == *"error:"* ]]; then
                    print -- "$r$line$x"
                else
                    print -- "$line"
                fi
            done
            ((i++))
        done
        ;;

    push)
        local -a repos=($~repo_glob)
        local count=${#repos}
        (( count == 0 )) && { printe "No repositories found in $GHDIR."; return 1; }

        printc "Pushing $count repositories to the remote." $y
        ptint "Working directory: $c$GHDIR$c"

        local i=1 repo
        for repo in $repos; do
            printc "\n$i/$count ${repo:t}" $g
            printc "$(git -C "$repo" remote get-url origin)" $c
            
            git -C "$repo" add --all
            # Suppress message if nothing to commit, allowing loop to continue
            git -C "$repo" commit -m "update" >/dev/null 2>&1
            git -C "$repo" push
            ((i++))
        done
        ;;

    push-force)
        # Operates on CURRENT DIRECTORY (exception to bulk logic)
        printc "Running force push sequence on CURRENT directory..." $y
        
        git add --all
        git commit -m "update"
        # Try continuing rebase if active, ignore error if not
        git rebase --continue 2>/dev/null
        git push origin HEAD:main --force
        ;;

    list)
        print -l $~repo_glob
        ;;

    reset)
        local -a repos=($~repo_glob)
        local count=${#repos}
        (( count == 0 )) && { printe "No repositories found in $GHDIR."; return 1; }

        printe "WARNING: This will reset ALL $count repositories to the latest commit on the main branch."
        
        # Native Zsh confirmation (read single char -q)
        if ! read -q "?${y}Are you sure you want to continue? [y/N] ${x}"; then
            print "" # Newline
            return 1
        fi
        print "" # Newline after confirmation

        local i=1 repo
        for repo in $repos; do
            printc "$i/$count ${repo:t}" $g
            printc "$(git -C "$repo" remote get-url origin)" $c
            
            git -C "$repo" fetch origin
            git -C "$repo" checkout main
            git -C "$repo" reset --hard origin/main
            git -C "$repo" pull
            ((i++))
        done
        ;;

    status)
        local -a repos=($~repo_glob)
        local count=${#repos}
        (( count == 0 )) && { printe "No repositories found in $GHDIR."; return 1; }

        printc "Checking status for $count repositories." $y

        local i=1 repo
        for repo in $repos; do
            printc "$i/$count ${repo:t}" $g
            git -C "$repo" status -s # -s for short format is usually better for bulk
            ((i++))
        done
        ;;

    help|-h|--help)
        printc "zgit - Git Bulk Operations" $y
        print "Usage: zgit <command>"
        print ""
        printul "${g}pull$x        : Pull --rebase all repos in \$GHDIR" \
                "${g}push$x        : Commit 'update' and push all repos in \$GHDIR" \
                "${g}push-force$x  : Force push CURRENT directory (rebase workflow)" \
                "${g}list$x        : List all repositories in \$GHDIR" \
                "${g}reset$x       : Hard reset all repos in \$GHDIR to origin/main" \
                "${g}status$x      : Show git status for all repos in \$GHDIR" \
                "${g}help$x        : Show this message"
        print "\nEnsure $y\$GHDIR$x is set to the parent directory containing your git repositories."
        print "Currently, $y\$GHDIR$x is set to: $c$GHDIR$c"
        ;;
    *)
        printe "zgit: Unknown command: $cmd"
        printi "Use 'zgit help' to see available commands."
        return 1
        ;;
esac