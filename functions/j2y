# Part of zconfig · https://github.com/barabasz/zconfig · MIT License
#
# Convert JSON to YAML using yq
# Use 'j2y --help' for more information.

local -A _fn=(
    [info]="Convert JSON to YAML"
    [desc]="Converts JSON input to YAML format using yq. Input can be a file or stdin.
            Output goes to stdout by default, or to a specified file."
    [version]="0.1.1"
    [created]="2026-02-05"
    [modified]="2026-02-05"
    [license]="MIT"
    [author]="Andrzej Barabasz"
    [notes]="Requires yq (https://github.com/mikefarah/yq)."
)

local -a _fn_args=(
    "input|Input JSON file (use - for stdin)|o"
    "output|Output YAML file (default: stdout)|o"
)

local -a _fn_opts=(
    "force|f|Overwrite output file without confirmation"
)

local -a _fn_examples=(
    "j2y data.json|Convert and print to stdout"
    "j2y data.json data.yaml|Convert to file"
    "j2y - out.yaml < in.json|Read from stdin, write to file"
    "curl -s api/data | j2y|Convert piped JSON to YAML"
)

local -A opts=() args=()
_fn_init "$@" || return $REPLY

# Check if yq is available
if ! is_installed yq; then
    printe "yq is required but not installed"
    printi "Install with: ${g}brew install yq${x}"
    return 1
fi

local input=${args[input]:-"-"}
local output=${args[output]:-""}
local force=$(( ${+opts[force]} ))

# Validate input file (if not stdin)
if [[ $input != "-" && ! -f $input ]]; then
    printe "Input file not found: ${c}$input${x}"
    return 1
fi

# Check output file
if [[ -n $output && -f $output ]] && (( ! force )); then
    if ! confirm "File ${c}$output${x} exists. Overwrite?"; then
        return 1
    fi
fi

# Perform conversion
if [[ -n $output ]]; then
    if [[ $input == "-" ]]; then
        yq -P -oy < /dev/stdin > "$output"
    else
        yq -P -oy "$input" > "$output"
    fi
    (( $? == 0 )) && prints "Converted: ${c}$input${x} -> ${c}$output${x}"
else
    if [[ $input == "-" ]]; then
        yq -P -oy < /dev/stdin
    else
        yq -P -oy "$input"
    fi
fi
