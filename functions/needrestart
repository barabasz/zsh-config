# needrestart - manage needrestart interactive prompts on Ubuntu
# Disables/enables the interactive restart prompt during apt operations
# -d | --disable : disable prompts (auto-restart services)
# -e | --enable  : enable prompts (ask before restart)
# -h | --help    : show help

# Ubuntu only
is_ubuntu || {
    printe "needrestart: this command is only available on Ubuntu"
    return 1
}

local conf="/etc/needrestart/needrestart.conf"

# Check if config exists
[[ -f $conf ]] || {
    printe "needrestart: config file not found: $conf"
    return 1
}

_needrestart_usage() {
    print "needrestart - manage needrestart interactive prompts"
    print ""
    print "Usage: needrestart [OPTION]"
    print ""
    print "Options:"
    print "  -d, --disable    Disable interactive prompts (auto-restart services)"
    print "  -e, --enable     Enable interactive prompts (ask before restart)"
    print "  -h, --help       Show this help"
    print ""
    print "This modifies $conf to control whether apt asks"
    print "about restarting services after package updates."
}

# Parse options
local -A opts
zparseopts -D -A opts d -disable e -enable h -help

if (( ${+opts[-h]} + ${+opts[--help]} )); then
    _needrestart_usage
    return 0
fi

if (( ${+opts[-d]} + ${+opts[--disable]} )); then
    sudo sed -i -e "s/#\$nrconf{restart} = 'i';/\$nrconf{restart} = 'a';/g" "$conf"
    print "needrestart: interactive prompts disabled (auto-restart enabled)"
    return 0
fi

if (( ${+opts[-e]} + ${+opts[--enable]} )); then
    sudo sed -i -e "s/\$nrconf{restart} = 'a';/#\$nrconf{restart} = 'i';/g" "$conf"
    print "needrestart: interactive prompts enabled"
    return 0
fi

# No valid option provided
_needrestart_usage
